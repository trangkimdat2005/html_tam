<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description"
    content="Vali is a responsive and free admin theme built with Bootstrap 5, SASS and PUG.js. It's fully customizable and modular.">
  <!-- Twitter meta-->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:site" content="@pratikborsadiya">
  <meta property="twitter:creator" content="@pratikborsadiya">
  <!-- Open Graph Meta-->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Vali Admin">
  <meta property="og:title" content="Vali - Free Bootstrap 5 admin theme">
  <meta property="og:url" content="http://pratikborsadiya.in/blog/vali-admin">
  <meta property="og:image" content="http://pratikborsadiya.in/blog/vali-admin/hero-social.png">
  <meta property="og:description"
    content="Vali is a responsive and free admin theme built with Bootstrap 5, SASS and PUG.js. It's fully customizable and modular.">
  <title>Vali Admin - Free Bootstrap 5 Admin Template</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Main CSS-->
  <link rel="stylesheet" type="text/css" href="../assets/lib/bootstrap/css/main.css">
  <!-- Font-icon css-->
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/lib/fontawesome/css/all.min.css" />
  <link rel="stylesheet" type="text/css" href="../assets/css/base.css" />
  <!-- Css riêng ở đây nha -->
  <link rel="stylesheet" type="text/css" href="../assets/css/ThemHoaDon.css">

</head>

<body class="app sidebar-mini">
  <!-- Navbar-->
  <header class="app-header"><a class="app-header__logo" href=" /QuanLyCuaHangTienLoi/index.html">Vali</a>
    <!-- Sidebar toggle button--><a class="app-sidebar__toggle" href="#" data-toggle="sidebar"
      aria-label="Hide Sidebar"></a>
    <!-- Navbar Right Menu-->
    <ul class="app-nav">
      <li class="app-search">
        <input class="app-search__input" type="search" placeholder="Search">
        <button class="app-search__button"><i class="bi bi-search"></i></button>
      </li>
      <!--Notification Menu-->
      <li class="dropdown"><a class="app-nav__item" href="#" data-bs-toggle="dropdown"
          aria-label="Show notifications"><i class="bi bi-bell fs-5"></i></a>
        <ul class="app-notification dropdown-menu dropdown-menu-right">
          <li class="app-notification__title">You have 4 new notifications.</li>
          <div class="app-notification__content">
            <li><a class="app-notification__item" href="javascript:;"><span class="app-notification__icon"><i
                    class="bi bi-envelope fs-4 text-primary"></i></span>
                <div>
                  <p class="app-notification__message">Lisa sent you a mail</p>
                  <p class="app-notification__meta">2 min ago</p>
                </div>
              </a></li>
            <li><a class="app-notification__item" href="javascript:;"><span class="app-notification__icon"><i
                    class="bi bi-exclamation-triangle fs-4 text-warning"></i></span>
                <div>
                  <p class="app-notification__message">Mail server not working</p>
                  <p class="app-notification__meta">5 min ago</p>
                </div>
              </a></li>
            <li><a class="app-notification__item" href="javascript:;"><span class="app-notification__icon"><i
                    class="bi bi-cash fs-4 text-success"></i></span>
                <div>
                  <p class="app-notification__message">Transaction complete</p>
                  <p class="app-notification__meta">2 days ago</p>
                </div>
              </a></li>
            <li><a class="app-notification__item" href="javascript:;"><span class="app-notification__icon"><i
                    class="bi bi-envelope fs-4 text-primary"></i></span>
                <div>
                  <p class="app-notification__message">Lisa sent you a mail</p>
                  <p class="app-notification__meta">2 min ago</p>
                </div>
              </a></li>
            <li><a class="app-notification__item" href="javascript:;"><span class="app-notification__icon"><i
                    class="bi bi-exclamation-triangle fs-4 text-warning"></i></span>
                <div>
                  <p class="app-notification__message">Mail server not working</p>
                  <p class="app-notification__meta">5 min ago</p>
                </div>
              </a></li>
            <li><a class="app-notification__item" href="javascript:;"><span class="app-notification__icon"><i
                    class="bi bi-cash fs-4 text-success"></i></span>
                <div>
                  <p class="app-notification__message">Transaction complete</p>
                  <p class="app-notification__meta">2 days ago</p>
                </div>
              </a></li>
          </div>
          <li class="app-notification__footer"><a href="#">See all notifications.</a></li>
        </ul>
      </li>
      <!-- User Menu-->
      <li class="dropdown"><a class="app-nav__item" href="#" data-bs-toggle="dropdown" aria-label="Open Profile Menu"><i
            class="bi bi-person fs-4"></i></a>
        <ul class="dropdown-menu settings-menu dropdown-menu-right">
          <li><a class="dropdown-item" href="page-user.html"><i class="bi bi-gear me-2 fs-5"></i> Settings</a></li>
          <li><a class="dropdown-item" href="page-user.html"><i class="bi bi-person me-2 fs-5"></i> Profile</a></li>
          <li><a class="dropdown-item" href="page-login.html"><i class="bi bi-box-arrow-right me-2 fs-5"></i> Logout</a>
          </li>
        </ul>
      </li>
    </ul>
  </header>

  <!-- Sidebar menu-->
  <div class="app-sidebar__overlay" data-toggle="sidebar"></div>
  <aside class="app-sidebar">
    <div class="app-sidebar__user"><img class="app-sidebar__user-avatar"
        src="https://randomuser.me/api/portraits/men/1.jpg" alt="User Image">
      <div>
        <p class="app-sidebar__user-name">John Doe</p>
        <p class="app-sidebar__user-designation">Frontend Developer</p>
      </div>
    </div>
    <ul class="app-menu">
      <li><a class="app-menu__item  " href=" /QuanLyCuaHangTienLoi/index.html"><i class="app-menu__icon bi bi-speedometer"></i><span
            class="app-menu__label">Bảng điều khiển</span></a></li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-bar-chart-steps"></i><span class="app-menu__label">Quản lý hàng hoá</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class="treeview-item space-first-right-khoi" href="../QuanLyHangHoa/DanhSachSanPham.html"></i> Danh sách sản
              phẩm</a></li>
          <li><a class="treeview-item space-first-right-khoi" href="../QuanLyHangHoa/DanhSachDanhMuc.html" 
              rel="noopener"></i> Quản lý danh mục</a></li>
          <li><a class="treeview-item space-first-right-khoi" href="../QuanLyHangHoa/DanhSachNhanHieu.html"> Danh sách nhãn
              hiệu</a></li>
          <li><a class="treeview-item space-first-right-khoi" href="../QuanLyHangHoa/DanhSachDonVi.html"> </i> Các đơn vị</a></li>
          <li><a class="treeview-item space-first-right-khoi" href="../QuanLyHangHoa/LichSuGiaBan.html"> </i> Lịch sử giá
              bán</a></li>
        </ul>
      </li>

      <li><a class="app-menu__item" href="../QuanLyHoaDon/DanhSachHoaDon.html"><i
            class="app-menu__icon bi bi-receipt-cutoff"></i><span class="app-menu__label">Danh sách hoá đơn</span></a>
      </li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi-person-circle"></i><span class="app-menu__label">Quản lý nhân sự</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyNhanSu/DanhSachNhanVien.html"> </i> Danh sách
              nhân viên</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyNhanSu/LichLamViec.html" 
              rel="noopener"> </i> Lịch làm việc</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyNhanSu/PhanCongCaLamViec.html"> </i> Phân công
              ca làm việc</a></li>
        </ul>
      </li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-people"></i><span class="app-menu__label">Quản lý khách hàng</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhachHang/DanhSachKhachHang.html"> </i> Danh sách khách
              hàng</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhachHang/TheThanhVien.html" 
              rel="noopener"> </i> Thẻ thành viên</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhachHang/LichSuMuaHang.html"> </i> Lịch sử mua hàng</a></li>
        </ul>
      </li>

      <li><a class="app-menu__item  " href="../QuanLyKhuyenMai/KhuyenMai.html"><i class="app-menu__icon bi bi-percent"></i><span
            class="app-menu__label">Quản lý khuyến mãi</span></a></li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-microsoft-teams"></i><span class="app-menu__label">Quản lý nhà cung cấp</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyNhaCungCap/DanhSachNhaCungCap.html"> </i> Danh sách các nhà
              cung cấp</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyNhaCungCap/LichSuGiaoDich.html" 
              rel="noopener"> </i> Lịch sử giao dịch</a></li>
        </ul>
      </li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-shop-window"></i><span class="app-menu__label">Quản lý kho hàng</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhoHang/DanhSachPhieuNhap.html"> </i> Danh sách phiếu
              nhập</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhoHang/DanhSachPhieuXuat.html" 
              rel="noopener"> </i> Danh sách phiếu xuất</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhoHang/ViTriSanPham.html" 
              rel="noopener"> </i> Vị trí sản phẩm</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhoHang/DanhSachHangTonKho.html" 
              rel="noopener"> </i> Danh sách hàng tồn kho</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyKhoHang/KiemKeSanPham.html" 
              rel="noopener"> </i> Kiểm kê sản phẩm</a></li>
        </ul>
      </li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-building"></i><span class="app-menu__label">Phân tích & Báo cáo</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../PhanTichBaoCao/BaoCaoDoanhThu.html"> </i> Báo cáo doanh
              thu</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../PhanTichBaoCao/BaoCaoBanChay.html" 
              rel="noopener"> </i> Báo cáo bán chạy</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../PhanTichBaoCao/BaoCaoTonKho.html" 
              rel="noopener"> </i> Báo cáo tồn kho</a></li>
        </ul>
      </li>

      <li><a class="app-menu__item  " href="../QuanLyDonHang/DanhSachDonHang.html"><i class="app-menu__icon bi bi-card-checklist"></i><span
            class="app-menu__label">Danh sách đơn hàng</span></a></li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-shield-exclamation"></i><span class="app-menu__label">Quản lý bảo mật</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyBaoMat/DanhSachTaiKhoanNhanVien.html"> </i> Tài khoản nhân
              viên</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyBaoMat/DanhSachTaiKhoanKhachHang.html" 
              rel="noopener"> </i> Tài khoản khách hàng</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyBaoMat/DanhSachTaiKhoan.html" 
              rel="noopener"> </i> Quản lý quyền</a></li>
        </ul>
      </li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-upc-scan"></i><span class="app-menu__label">Quản lý barcode</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyBarCode/DinhDanhSanPham.html"> </i> Định danh sản
              phẩm</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../QuanLyBarCode/DanhSachTemNhan.html" 
              rel="noopener"> </i> Danh sách tem nhãn</a></li>
        </ul>
      </li>

      <li class="treeview"><a class="app-menu__item" href="#" data-toggle="treeview"><i
            class="app-menu__icon bi bi-cash-coin"></i><span class="app-menu__label">Giao dịch & hoàn trả</span><i
            class="treeview-indicator bi bi-chevron-right"></i></a>
        <ul class="treeview-menu">
          <li><a class=" treeview-item space-first-right-khoi" href="../GiaoDichHoanTra/GiaoDichThanhToan.html"> </i> Giao dịch thanh
              toán</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../GiaoDichHoanTra/PhieuDoiTra.html" 
              rel="noopener"> </i> Phiếu đổi trả</a></li>
          <li><a class=" treeview-item space-first-right-khoi" href="../GiaoDichHoanTra/ChinhSachDoiTra.html" 
              rel="noopener"></i> Chính sách hoàn trả</a></li>
        </ul>
      </li>
      <li><a class="app-menu__item  " href="../ThanhToan/ThanhToan.html"><i class="app-menu__icon bi bi-wallet"></i><span
            class="app-menu__label">Thanh toán</span></a></li>
    </ul>
  </aside>
  <!-- Main sidebar ở đây nha -->






  <main class="app-content">
    <div class="app-title">
      <div>
        <h1><i class="bi bi-receipt-cutoff"></i> Tạo Hoá Đơn Bán Hàng (POS)</h1>
        <p>Giao diện bán hàng tại quầy</p>
      </div>
      <ul class="app-breadcrumb breadcrumb">
        <li class="breadcrumb-item"><i class="bi bi-house-door fs-6"></i></li>
        <li class="breadcrumb-item"><a href="#">Quản lý bán hàng</a></li>
        <li class="breadcrumb-item"><a href="#">Tạo hoá đơn</a></li>
      </ul>
    </div>
    <div class="row">

      <div class="col-md-7">
        <div class="tile">
          <h3 class="tile-title">Chi tiết Hoá Đơn</h3>
          <div class="tile-body">

            <div class="row mb-3">
              <div class="col-md-9">
                <label class="form-label">Khách hàng</label>
                <select class="form-control" id="selectKhachHang" style="width: 100%;">
                  <option value="khach_le">Khách lẻ</option>
                  <option value="kh_01">Nguyễn Văn A (090xxxx123)</option>
                  <option value="kh_02">Trần Thị B (091xxxx456)</option>
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary" type="button"><i class="bi bi-plus-lg"></i> Thêm mới</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Sản phẩm</th>
                    <th style="width: 100px;">Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                    <th style="width: 50px;">Xoá</th>
                  </tr>
                </thead>
                <tbody id="invoice-items-body">
                </tbody>
              </table>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Mã giảm giá (từ bảng MaKhuyenMai)</label>
                  <div class="input-group">
                    <input class="form-control" id="discount-code-input" type="text" placeholder="Nhập mã...">
                    <button class="btn btn-outline-primary" type="button" id="apply-discount-btn">Áp dụng</button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h5 class="fw-normal">Tạm tính: <span id="sub-total" class="float-end">0 đ</span></h5>
                <h5>Giảm giá: <span id="discount-amount" class="float-end text-danger">0 đ</span></h5>
                <hr>
                <h4 class="fw-bold">Tổng cộng: <span id="total-amount" class="float-end text-primary">0 đ</span></h4>
              </div>
            </div>
          </div>

          <div class="tile-footer text-end">
            <button class="btn btn-secondary" type="button" id="cancel-invoice-btn"><i
                class="bi bi-x-circle me-2"></i>Huỷ</button>

            <button class="btn btn-primary" type="button" id="save-draft-btn">
              <i class="bi bi-save me-2"></i>Lưu tạm
            </button>

            <button class="btn btn-success" type="button" id="checkout-btn"><i
                class="bi bi-currency-dollar me-2"></i>Thanh toán</button>
          </div>
        </div>
      </div>

      <div class="col-md-5">

        <div class="tile">
          <h3 class="tile-title">Danh sách Sản phẩm</h3>

          <div class="mb-3">
            <input type="text" class="form-control" id="product-search-input"
              placeholder="Tìm kiếm sản phẩm (tên hoặc mã)...">
          </div>
          <div class="mb-3">
            <select class="form-control" id="selectDanhMuc">
              <option value="all">Tất cả danh mục</option>
              <option value="dm_01">Đồ uống</option>
              <option value="dm_02">Đồ ăn nhanh</option>
              <option value="dm_03">Hàng gia dụng</option>
            </select>
          </div>

          <div class="product-list-container">
            <ul class="list-group" id="product-list">
              <li class="list-group-item d-flex justify-content-between align-items-center product-item"
                data-category="dm_01">
                <div>
                  <h6 class="mb-0">Sting Dâu</h6>
                  <small class="text-muted">10,000 đ</small>
                </div>
                <button class="btn btn-primary btn-sm add-product-btn" data-id="spdv_01" data-name="Sting Dâu"
                  data-price="10000">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center product-item"
                data-category="dm_02">
                <div>
                  <h6 class="mb-0">Bánh mì Sandwich</h6>
                  <small class="text-muted">22,000 đ</small>
                </div>
                <button class="btn btn-primary btn-sm add-product-btn" data-id="spdv_02" data-name="Bánh mì Sandwich"
                  data-price="22000">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center product-item"
                data-category="dm_01">
                <div>
                  <h6 class="mb-0">Coca Cola</h6>
                  <small class="text-muted">12,000 đ</small>
                </div>
                <button class="btn btn-primary btn-sm add-product-btn" data-id="spdv_03" data-name="Coca Cola"
                  data-price="12000">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center product-item"
                data-category="dm_03">
                <div>
                  <h6 class="mb-0">Dao cạo râu</h6>
                  <small class="text-muted">45,000 đ</small>
                </div>
                <button class="btn btn-primary btn-sm add-product-btn" data-id="spdv_04" data-name="Dao cạo râu"
                  data-price="45000">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>

        <div class="tile">
          <h3 class="tile-title">Hoá Đơn Tạm Lưu</h3>
          <div class="draft-list-container">
            <ul class="list-group" id="draft-list">
            </ul>
          </div>
        </div>

      </div>
    </div>
  </main>









  <!-- Essential javascripts for application to work-->
  <script src="../assets/lib/jquery/jquery-3.7.0.min.js"></script>
  <script src="../assets/lib/bootstrap/js/bootstrap.min.js"></script>
  <script src="../assets/lib/select2/dist/js/select2.full.min.js"></script>
  <script src="../assets/lib/bootstrap/js/main.js"></script>

  <!-- js riêng ở đây nha! -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // --- KHỞI TẠO SELECT2 ---
      $('#selectKhachHang').select2({
        width: '100%'
      });
      $('#selectDanhMuc').select2({
        width: '100%'
      });

      // --- CÁC BIẾN LƯU TRỮ ---
      // Dùng để lưu trữ dữ liệu của các hoá đơn tạm
      let savedDrafts = {};

      // --- TRUY XUẤT PHẦN TỬ DOM ---
      const productList = document.getElementById('product-list');
      const invoiceBody = document.getElementById('invoice-items-body');
      const subTotalEl = document.getElementById('sub-total');
      const discountEl = document.getElementById('discount-amount');
      const totalEl = document.getElementById('total-amount');
      const searchInput = document.getElementById('product-search-input');
      const categorySelect = document.getElementById('selectDanhMuc');
      const customerSelect = $('#selectKhachHang'); // jQuery object
      const discountInput = document.getElementById('discount-code-input');

      // Nút bấm
      const saveDraftBtn = document.getElementById('save-draft-btn');
      const cancelInvoiceBtn = document.getElementById('cancel-invoice-btn');

      // Danh sách hoá đơn tạm
      const draftList = document.getElementById('draft-list');

      // Hàm định dạng tiền tệ (vi-VN)
      const formatter = new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      });

      // =======================================================
      // 1. CHỨC NĂNG LỌC SẢN PHẨM (Không đổi)
      // =======================================================
      function filterProducts() {
        const searchText = searchInput.value.toLowerCase();
        const category = categorySelect.value;
        const allProducts = productList.querySelectorAll('.product-item');

        allProducts.forEach(product => {
          const productName = product.querySelector('h6').textContent.toLowerCase();
          const productCategory = product.getAttribute('data-category');
          const matchesSearch = productName.includes(searchText);
          const matchesCategory = (category === 'all' || productCategory === category);

          if (matchesSearch && matchesCategory) {
            product.classList.remove('hide');
          } else {
            product.classList.add('hide');
          }
        });
      }
      searchInput.addEventListener('keyup', filterProducts);
      categorySelect.addEventListener('change', filterProducts);

      // =======================================================
      // 2. CHỨC NĂNG GIỎ HÀNG (Thêm, Xoá, Cập nhật)
      // =======================================================

      // --- Thêm sản phẩm vào hoá đơn ---
      productList.addEventListener('click', function (e) {
        const addButton = e.target.closest('.add-product-btn');
        if (addButton) {
          const id = addButton.getAttribute('data-id');
          const name = addButton.getAttribute('data-name');
          const price = parseFloat(addButton.getAttribute('data-price'));
          addProductToInvoice(id, name, price);
        }
      });

      /**
       * Thêm 1 sản phẩm vào bảng chi tiết.
       * @param {string} id - Mã sản phẩm (ví dụ: spdv_01)
       * @param {string} name - Tên sản phẩm
       * @param {number} price - Đơn giá
       * @param {number} [quantity=1] - Số lượng (dùng khi tải lại draft)
       */
      function addProductToInvoice(id, name, price, quantity = 1) {
        const existingRow = document.querySelector(`#invoice-items-body tr[data-id="${id}"]`);

        if (existingRow) {
          // Nếu đã có, tăng số lượng
          const qtyInput = existingRow.querySelector('.quantity-input');
          qtyInput.value = parseInt(qtyInput.value) + quantity;
          updateRowTotal(existingRow);
        } else {
          // Nếu chưa có, tạo dòng mới
          const row = invoiceBody.insertRow();
          row.setAttribute('data-id', id);
          row.innerHTML = `
            <td>${name}</td>
            <td><input type="number" class="form-control quantity-input" value="${quantity}" min="1" data-price="${price}"></td>
            <td>${formatter.format(price)}</td>
            <td class="row-total">${formatter.format(price * quantity)}</td>
            <td><button class="btn btn-danger btn-sm remove-item-btn"><i class="bi bi-trash"></i></button></td>
          `;
        }
        updateInvoiceTotal(); // Cập nhật tổng tiền
      }

      // --- Xoá sản phẩm / Thay đổi số lượng ---
      invoiceBody.addEventListener('input', function (e) {
        // Cập nhật khi thay đổi số lượng
        const qtyInput = e.target.closest('.quantity-input');
        if (qtyInput) {
          if (qtyInput.value < 1) qtyInput.value = 1;
          const row = qtyInput.closest('tr');
          updateRowTotal(row);
          updateInvoiceTotal();
        }
      });

      invoiceBody.addEventListener('click', function (e) {
        // Xử lý nút Xoá
        const removeButton = e.target.closest('.remove-item-btn');
        if (removeButton) {
          removeButton.closest('tr').remove();
          updateInvoiceTotal(); // Cập nhật lại tổng tiền
        }
      });

      // --- Các hàm tính toán ---
      function updateRowTotal(row) {
        const qtyInput = row.querySelector('.quantity-input');
        const price = parseFloat(qtyInput.getAttribute('data-price'));
        const quantity = parseInt(qtyInput.value);
        const total = price * quantity;
        row.querySelector('.row-total').textContent = formatter.format(total);
      }

      function updateInvoiceTotal() {
        let subTotal = 0;
        const allRows = invoiceBody.querySelectorAll('tr');
        allRows.forEach(row => {
          const qtyInput = row.querySelector('.quantity-input');
          const price = parseFloat(qtyInput.getAttribute('data-price'));
          const quantity = parseInt(qtyInput.value);
          subTotal += price * quantity;
        });

        const discount = 0; // Logic giảm giá sẽ thêm sau
        const total = subTotal - discount;

        subTotalEl.textContent = formatter.format(subTotal);
        discountEl.textContent = formatter.format(discount);
        totalEl.textContent = formatter.format(total);
      }

      // =======================================================
      // 3. CHỨC NĂNG HOÁ ĐƠN (Lưu tạm, Tải tạm, Huỷ)
      // =======================================================

      // --- Xoá trắng hoá đơn hiện tại ---
      function clearInvoice() {
        invoiceBody.innerHTML = '';
        customerSelect.val('khach_le').trigger('change'); // Reset về khách lẻ
        discountInput.value = '';
        updateInvoiceTotal(); // Tính lại tổng tiền (về 0)
      }

      // --- Bấm nút Huỷ ---
      cancelInvoiceBtn.addEventListener('click', function () {
        if (confirm('Bạn có chắc muốn huỷ hoá đơn này? Mọi dữ liệu sẽ bị mất.')) {
          clearInvoice();
        }
      });

      // --- Bấm nút "Lưu tạm" ---
      saveDraftBtn.addEventListener('click', function () {
        const items = [];
        const allRows = invoiceBody.querySelectorAll('tr');

        // 1. Kiểm tra xem có sản phẩm nào không
        if (allRows.length === 0) {
          alert('Chưa có sản phẩm nào trong hoá đơn để lưu tạm.');
          return;
        }

        // 2. Lấy thông tin khách hàng
        const customerValue = customerSelect.val();
        const customerName = customerSelect.find('option:selected').text();

        // 3. Lấy thông tin tất cả sản phẩm
        allRows.forEach(row => {
          const qtyInput = row.querySelector('.quantity-input');
          items.push({
            id: row.getAttribute('data-id'),
            name: row.cells[0].textContent,
            quantity: parseInt(qtyInput.value),
            price: parseFloat(qtyInput.getAttribute('data-price'))
          });
        });

        // 4. Lấy thông tin tổng tiền
        const totalText = totalEl.textContent;
        const draftId = 'draft-' + new Date().getTime(); // Tạo ID duy nhất

        // 5. Tạo đối tượng hoá đơn tạm
        const draftData = {
          id: draftId,
          customer: {
            value: customerValue,
            name: customerName
          },
          items: items,
          total: totalText
        };

        // 6. Lưu vào kho lưu trữ (biến savedDrafts)
        savedDrafts[draftId] = draftData;
        console.log("Đã lưu tạm:", savedDrafts);

        // 7. Thêm vào danh sách bên phải
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center draft-item';
        li.setAttribute('data-draft-id', draftId);
        li.innerHTML = `
          <div>
            <h6 class="mb-0">${customerName}</h6>
            <small class="text-muted">Tổng: ${totalText} (${items.length} SP)</small>
          </div>
          <button class="btn btn-danger btn-sm remove-draft-btn">
            <i class="bi bi-x-lg"></i>
          </button>
        `;
        draftList.appendChild(li);

        // 8. Xoá trắng hoá đơn hiện tại
        clearInvoice();
      });

      // --- Xử lý danh sách hoá đơn tạm (Tải lại hoặc Xoá) ---
      draftList.addEventListener('click', function (e) {
        const draftItem = e.target.closest('.draft-item');
        if (!draftItem) return; // Không làm gì nếu không nhấn vào 1 item

        const draftId = draftItem.getAttribute('data-draft-id');
        const draftData = savedDrafts[draftId];

        // Trường hợp 1: Nhấn nút "Xoá"
        if (e.target.closest('.remove-draft-btn')) {
          if (confirm(`Bạn có chắc muốn XOÁ hoá đơn tạm của "${draftData.customer.name}"?`)) {
            delete savedDrafts[draftId]; // Xoá khỏi bộ nhớ
            draftItem.remove(); // Xoá khỏi giao diện
          }
        }
        // Trường hợp 2: Nhấn vào để "Tải lại"
        else {
          // Kiểm tra xem hoá đơn hiện tại có trống không
          if (invoiceBody.querySelectorAll('tr').length > 0) {
            if (!confirm('Hoá đơn hiện tại có dữ liệu. Bạn có muốn xoá và tải hoá đơn tạm?')) {
              return;
            }
          }

          // Tải hoá đơn
          clearInvoice(); // Xoá trắng

          // 1. Set lại khách hàng
          customerSelect.val(draftData.customer.value).trigger('change');

          // 2. Thêm lại các sản phẩm
          draftData.items.forEach(item => {
            // Dùng hàm addProductToInvoice với số lượng cụ thể
            addProductToInvoice(item.id, item.name, item.price, item.quantity);
          });

          // 3. Xoá hoá đơn tạm sau khi đã tải
          delete savedDrafts[draftId];
          draftItem.remove();
        }
      });

    });
  </script>


</body>

</html>